name: ğŸ§ª CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  statuses: write
  checks: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    name: ğŸ§ª Tests & Quality
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3']
    env:
      APP_ENV: test
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/chess_teams_test
      REDIS_URL: redis://redis:6379/1
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: chess_teams_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: ctype, iconv, json, pdo, pdo_pgsql, tokenizer, redis
        coverage: xdebug
        tools: composer:v2

    - name: ğŸ“‹ Validate composer.json
      run: composer validate --strict

    - name: ğŸ“¦ Install PHP dependencies (cached)
      uses: ramsey/composer-install@v3
      with:
        composer-options: --prefer-dist --no-progress --optimize-autoloader

    - name: ğŸ”§ Show environment
      run: |
        php -v
        composer --version
        echo "APP_ENV=$APP_ENV"
        echo "DATABASE_URL=$DATABASE_URL"
        echo "REDIS_URL=$REDIS_URL"

    - name: ğŸ—„ï¸ Setup database
      run: |
        php bin/console doctrine:database:create --if-not-exists --env=test
        php bin/console doctrine:migrations:migrate --no-interaction --env=test

    - name: ğŸ§ª Run unit tests
      run: ./vendor/bin/phpunit --testsuite=unit --coverage-clover=coverage.xml

    - name: ğŸ”— Run functional tests
      run: ./vendor/bin/phpunit --testsuite=functional

    - name: ğŸ“Š Upload coverage to Codecov
      if: ${{ env.CODECOV_TOKEN != '' }}
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        token: ${{ env.CODECOV_TOKEN }}

  code-quality:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: ctype, iconv, json
        tools: composer:v2

    - name: ğŸ“¦ Install dependencies (cached)
      uses: ramsey/composer-install@v3
      with:
        composer-options: --prefer-dist --no-progress

    - name: ğŸ¨ Check code style
      run: composer cs:check

    - name: ğŸ” Run PHPStan
      run: |
        if [ -f phpstan.neon ]; then
          ./vendor/bin/phpstan analyze
        else
          echo "PHPStan not configured, skipping..."
        fi

  assets:
    name: ğŸ¨ Assets & Frontend
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: ğŸ“¦ Install PHP dependencies (cached)
      uses: ramsey/composer-install@v3
      with:
        composer-options: --prefer-dist --no-progress

    - name: ğŸ¨ Compile assets
      env:
        APP_ENV: prod
      run: php bin/console asset-map:compile --env=prod

    - name: âœ… Verify asset compilation
      run: |
        if [ ! -f public/assets/manifest.json ]; then
          echo "âŒ Asset compilation failed - manifest.json not found"
          exit 1
        fi
        echo "âœ… Assets compiled successfully"

  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: ğŸ“¦ Install dependencies (cached)
      uses: ramsey/composer-install@v3
      with:
        composer-options: --prefer-dist --no-progress

    - name: ğŸ›¡ï¸ Security audit
      run: |
        # Composer audit pour les vulnÃ©rabilitÃ©s connues
        composer audit
        
        # VÃ©rifier les permissions des fichiers sensibles
        find . -name "*.env*" -type f -perm /o+r && echo "âŒ Environment files are world-readable" && exit 1 || echo "âœ… Environment files permissions OK"

  deployment:
    name: ğŸš€ Deployment
    runs-on: ubuntu-latest
    needs: [tests, code-quality, assets, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: ğŸ“¦ Install production dependencies (cached)
      uses: ramsey/composer-install@v3
      with:
        composer-options: --no-dev --optimize-autoloader --prefer-dist --no-progress

    - name: ğŸ¨ Compile production assets
      run: php bin/console asset-map:compile --env=prod

    - name: ğŸ“‹ Create deployment artifact
      run: |
        tar -czf chess-teams-${{ github.sha }}.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='tests' \
          --exclude='var/cache' \
          --exclude='var/log' \
          .

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: chess-teams-${{ github.sha }}
        path: chess-teams-${{ github.sha }}.tar.gz
        retention-days: 30

    # Exemple de dÃ©ploiement (Ã  adapter selon votre infrastructure)
    # - name: ğŸš€ Deploy to production
    #   run: |
    #     # Vos commandes de dÃ©ploiement ici
    #     echo "Deploying to production..."

  notification:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [tests, code-quality, assets, security]
    if: always()

    steps:
    - name: ğŸ“¢ Notify Discord
      if: failure()
      run: |
        # Envoyer une notification Discord en cas d'Ã©chec
        echo "Build failed - would send Discord notification"
        
    - name: ğŸ“§ Notify Email
      if: failure() && github.ref == 'refs/heads/main'
      run: |
        # Envoyer email en cas d'Ã©chec sur main
        echo "Critical build failure on main - would send email"

  tests-full-docker:
    name: ğŸ³ Tests (Full Docker)
    runs-on: ubuntu-latest
    # Peut Ãªtre exÃ©cutÃ© en parallÃ¨le des autres jobs, n'est pas requis par le dÃ©ploiement par dÃ©faut
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Show Docker versions
        run: |
          docker --version
          docker compose version

      - name: ğŸ§± Build PHP container (compose override)
        run: |
          docker compose -f compose.yaml -f compose.override.yaml build php

      - name: ğŸ—„ï¸ Start database service
        run: |
          docker compose -f compose.yaml -f compose.override.yaml up -d database

      - name: â±ï¸ Wait for Postgres to be healthy
        run: |
          echo "Waiting for Postgres to be ready..."
          for i in {1..30}; do
            if docker compose -f compose.yaml -f compose.override.yaml exec -T database pg_isready -U app -h 127.0.0.1 -p 5432; then
              echo "Postgres is ready"
              break
            fi
            echo "Postgres not ready yet, retry $i/30" && sleep 2
          done

      - name: ğŸ“¦ Install PHP dependencies
        run: |
          docker compose -f compose.yaml -f compose.override.yaml run --rm \
            -e APP_ENV=test \
            -e DATABASE_URL=postgresql://app:!ChangeMe!@database:5432/chess_teams_test \
            php composer install --prefer-dist --no-progress --optimize-autoloader

      - name: ğŸ—ƒï¸ Setup test database (migrate)
        run: |
          docker compose -f compose.yaml -f compose.override.yaml run --rm \
            -e APP_ENV=test \
            -e DATABASE_URL=postgresql://app:!ChangeMe!@database:5432/chess_teams_test \
            php sh -lc "php bin/console doctrine:database:create --if-not-exists --env=test && php bin/console doctrine:migrations:migrate -n --env=test"

      - name: ğŸ§ª Run tests inside container
        run: |
          docker compose -f compose.yaml -f compose.override.yaml run --rm \
            -e APP_ENV=test \
            -e XDEBUG_MODE=coverage \
            -e DATABASE_URL=postgresql://app:!ChangeMe!@database:5432/chess_teams_test \
            php ./vendor/bin/phpunit --testsuite=unit,functional --coverage-clover=coverage.xml

      - name: ğŸ“¤ Upload coverage artifact (Full Docker)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-full-docker-${{ github.sha }}
          path: coverage.xml

      - name: ğŸ§¹ Teardown
        if: always()
        run: |
          docker compose -f compose.yaml -f compose.override.yaml down -v || true
