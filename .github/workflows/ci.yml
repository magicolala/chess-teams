name: ğŸ§ª CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    name: ğŸ§ª Tests & Quality
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3']
        
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: chess_teams_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: ctype, iconv, json, pdo, pdo_pgsql, tokenizer, redis
        coverage: xdebug
        tools: composer:v2

    - name: ğŸ“‹ Validate composer.json
      run: composer validate --strict

    - name: ğŸ’¾ Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: /tmp/composer-cache
        key: ${{ runner.os }}-php${{ matrix.php-version }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php${{ matrix.php-version }}-composer-

    - name: ğŸ“¦ Install PHP dependencies
      run: composer install --prefer-dist --no-progress --optimize-autoloader

    - name: ğŸ”§ Setup environment
      run: |
        cp .env.test .env.test.local
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/chess_teams_test" >> .env.test.local
        echo "REDIS_URL=redis://localhost:6379/1" >> .env.test.local

    - name: ğŸ—„ï¸ Setup database
      run: |
        php bin/console doctrine:database:create --env=test
        php bin/console doctrine:migrations:migrate --no-interaction --env=test

    - name: ğŸ§ª Run unit tests
      run: ./vendor/bin/phpunit --testsuite=unit --coverage-clover=coverage.xml

    - name: ğŸ”— Run functional tests
      run: ./vendor/bin/phpunit --testsuite=functional

    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  code-quality:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: ctype, iconv, json
        tools: composer:v2

    - name: ğŸ“¦ Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: ğŸ¨ Check code style
      run: composer cs:check

    - name: ğŸ” Run PHPStan
      run: |
        if [ -f phpstan.neon ]; then
          ./vendor/bin/phpstan analyze
        else
          echo "PHPStan not configured, skipping..."
        fi

  assets:
    name: ğŸ¨ Assets & Frontend
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: ğŸ“¦ Install PHP dependencies
      run: composer install --prefer-dist --no-progress

    - name: ğŸ¨ Compile assets
      run: php bin/console asset-map:compile --env=prod

    - name: âœ… Verify asset compilation
      run: |
        if [ ! -f public/assets/manifest.json ]; then
          echo "âŒ Asset compilation failed - manifest.json not found"
          exit 1
        fi
        echo "âœ… Assets compiled successfully"

  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: ğŸ“¦ Install dependencies
      run: composer install --prefer-dist --no-progress

    - name: ğŸ›¡ï¸ Security audit
      run: |
        # Composer audit pour les vulnÃ©rabilitÃ©s connues
        composer audit
        
        # VÃ©rifier les permissions des fichiers sensibles
        find . -name "*.env*" -type f -perm /o+r && echo "âŒ Environment files are world-readable" && exit 1 || echo "âœ… Environment files permissions OK"

  deployment:
    name: ğŸš€ Deployment
    runs-on: ubuntu-latest
    needs: [tests, code-quality, assets, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: ğŸ“¦ Install production dependencies
      run: composer install --no-dev --optimize-autoloader --prefer-dist --no-progress

    - name: ğŸ¨ Compile production assets
      run: php bin/console asset-map:compile --env=prod

    - name: ğŸ“‹ Create deployment artifact
      run: |
        tar -czf chess-teams-${{ github.sha }}.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='tests' \
          --exclude='var/cache' \
          --exclude='var/log' \
          .

    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: chess-teams-${{ github.sha }}
        path: chess-teams-${{ github.sha }}.tar.gz
        retention-days: 30

    # Exemple de dÃ©ploiement (Ã  adapter selon votre infrastructure)
    # - name: ğŸš€ Deploy to production
    #   run: |
    #     # Vos commandes de dÃ©ploiement ici
    #     echo "Deploying to production..."

  notification:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [tests, code-quality, assets, security]
    if: always()

    steps:
    - name: ğŸ“¢ Notify Discord
      if: failure()
      run: |
        # Envoyer une notification Discord en cas d'Ã©chec
        echo "Build failed - would send Discord notification"
        
    - name: ğŸ“§ Notify Email
      if: failure() && github.ref == 'refs/heads/main'
      run: |
        # Envoyer email en cas d'Ã©chec sur main
        echo "Critical build failure on main - would send email"
