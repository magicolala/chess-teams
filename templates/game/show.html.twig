{% extends 'base.html.twig' %}
{% block title %}Partie
	{{ game.id }}
{% endblock %}

{% block styles %}
	<style>
		/* Styles sp√©cifiques pour l'√©chiquier et la page de jeu */
		.game-container {
			display: grid;
			grid-template-columns: 1fr 350px;
			gap: 2rem;
			align-items: start;
			margin-top: 1rem;
		}
		.board-container {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}
		.game-actions {
			display: flex;
			gap: 0.5rem;
			flex-wrap: wrap;
		}
		.moves-list {
			font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
			font-size: 0.9rem;
			max-height: 200px;
			overflow-y: auto;
			padding: 0;
			margin: 0;
		}
		.move-item {
			display: flex;
			justify-content: space-between;
			padding: 0.25rem 0.5rem;
			border-bottom: 1px solid var(--neo-border-color);
		}
		.player-list {
			list-style: none;
			padding: 0;
			margin: 0;
			gap: 0.5rem;
			display: flex;
			flex-direction: column;
		}
		.player-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0.75rem;
			background: var(--neo-bg-secondary);
			border-radius: 8px;
			border: 1px solid var(--neo-border-color);
		}
		.player-item.current-player {
			border-color: var(--neo-primary);
			background: var(--neo-primary-light);
		}
		.player-info {
			display: flex;
			align-items: center;
			gap: 0.75rem;
		}
		.player-details {
			display: flex;
			flex-direction: column;
			gap: 0.25rem;
		}
		.player-name {
			font-weight: 600;
			color: var(--neo-text-primary);
		}
		.player-meta {
			font-size: 0.8rem;
			color: var(--neo-text-secondary);
		}
		.player-status {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		@media (max-width: 768px) {
			.game-container {
				grid-template-columns: 1fr;
				gap: 1rem;
			}
		}
	</style>
{% endblock %}

{% block body %}
	<div class="neo-animate-fadeIn">
		<div class="neo-text-center neo-mb-xl">
			<h1 class="neo-text-2xl neo-font-bold neo-text-primary">
				‚ôüÔ∏è Partie {{ game.id }}
			</h1>
		</div>

		<div class="game-container neo-animate-slideIn" data-controller="game-board game-poll" data-game-board-fen-value="{{ initial.fen }}" data-game-board-game-id-value="{{ initial.gameId }}" data-game-board-turn-team-value="{{ initial.turnTeam }}" data-game-board-status-value="{{ initial.status }}" data-game-board-deadline-ts-value="{{ initial.turnDeadline ?: 0 }}" data-game-poll-game-id-value="{{ initial.gameId }}">
			<!-- Colonne de gauche: √âchiquier + √âtat -->
			<div class="board-container">
				<div id="board" class="cg-wrap coordinates"></div>
				<div class="game-actions">
					<button class="neo-btn neo-btn-secondary neo-btn-sm" data-action="game-board#offerMove" data-uci="e2e4">
						‚ñ∂Ô∏è Jouer e2e4 (d√©mo)
					</button>
					<button class="neo-btn neo-btn-warning neo-btn-sm" data-action="game-board#tick">
						‚è∞ Tick (timeout)
					</button>
				</div>
			</div>

			<!-- Colonne de droite: Historique + √âquipes -->
			<div class="sidebar-container">
				<div class="neo-card neo-mb-lg">
					<div class="neo-card-header">
						<h3 class="neo-card-title">‚ÑπÔ∏è √âtat de la partie</h3>
					</div>
					<div class="neo-card-content">
						<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
							<span class="neo-text-sm neo-font-medium">Tour actuel:</span>
							<span class="neo-badge neo-badge-primary" data-game-board-target="turnTeam">{{ initial.turnTeam }}</span>
						</div>
						{% if currentPlayer and game.status == 'live' %}
						<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-info neo-rounded">
							<span class="neo-text-sm neo-font-medium">Joueur actuel:</span>
							<span class="neo-text-sm">
								{{ currentPlayer.user.displayName ?? 'Joueur' }} (√âquipe {{ currentPlayer.team.name }})
								{% if userMembership and userMembership.id == currentPlayer.id %}
									‚≠ê 
								{% endif %}
							</span>
						</div>
						{% endif %}
						<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
							<span class="neo-text-sm neo-font-medium">Temps restant:</span>
							<span class="neo-text-sm neo-font-mono neo-text-warning" data-game-board-target="timer">-</span>
						</div>
						<div class="neo-flex neo-justify-between neo-items-center neo-p-sm neo-bg-secondary neo-rounded">
							<span class="neo-text-sm neo-font-medium">Statut:</span>
							<div>
								<span class="neo-badge neo-badge-secondary" data-game-board-target="status">{{ initial.status }}</span>
								<span data-game-board-target="result"></span>
							</div>
						</div>
					</div>
				</div>

				<div class="neo-card neo-mb-lg">
					<div class="neo-card-header">
						<h3 class="neo-card-title">üìã Historique des coups</h3>
					</div>
					<div class="neo-card-content">
						<ol class="moves-list" id="moves-list">
							{% for m in moves %}
								<li class="move-item">
									<span class="move-notation">#{{ m.ply }}: {{ m.san ?? m.uci }}</span>
									<span class="neo-badge neo-badge-sm team-{{ m.team.name|lower }}">{{ m.team.name }}</span>
								</li>
							{% endfor %}
						</ol>
					</div>
				</div>

				<div class="neo-card">
					<div class="neo-card-header">
						<h3 class="neo-card-title">üë• √âquipes</h3>
					</div>
					<div class="neo-card-content">

			<div class="team-section team-a">
				<div class="team-header">
					<i class="material-icons">group</i>
					<span class="team-badge">√âquipe A</span>
					<span class="team-count">{{ teamA.members|length }} joueur{{ teamA.members|length > 1 ? 's' : '' }}</span>
				</div>
				{% if teamA and teamA.members|length > 0 %}
					<ul class="player-list">
					{% for member in teamA.members %}
						<li class="player-item{% if currentPlayer and currentPlayer.id == member.id %} current-player{% endif %}">
							<div class="player-info">
								<div class="player-avatar">
									<i class="material-icons">{{ member.user.displayName ? 'account_circle' : 'person_outline' }}</i>
								</div>
								<div class="player-details">
									<span class="player-name">
										{{ member.user.displayName ?? ('Joueur #' ~ loop.index) }}
									</span>
									<span class="player-meta">
										<i class="material-icons tiny">schedule</i>
										Rejoint {{ member.joinedAt|date('d/m √† H:i') }}
										{% if member.position > 0 %}
											‚Ä¢ Position {{ member.position }}
										{% endif %}
									</span>
								</div>
							</div>
							<div class="player-status">
								{% if currentPlayer and currentPlayer.id == member.id %}
									<span class="status-current">
										<i class="material-icons">play_arrow</i>
										√Ä son tour
									</span>
								{% elseif member.isReadyToStart %}
									<span class="status-ready">
										<i class="material-icons">check_circle</i>
										Pr√™t
									</span>
								{% else %}
									<span class="status-waiting">
										<i class="material-icons">hourglass_empty</i>
										En attente
									</span>
								{% endif %}
								{% if userMembership and userMembership.id == member.id %}
									<span class="status-you">
										<i class="material-icons">star</i>
										Vous
									</span>
								{% endif %}
							</div>
						</li>
					{% endfor %}
					</ul>
				{% else %}
					<div class="empty-team">
						<i class="material-icons">group_add</i>
						<p>Aucun joueur dans cette √©quipe</p>
					</div>
				{% endif %}
				{% if is_granted('IS_AUTHENTICATED_FULLY') and not userMembership and game.status == 'lobby' %}
					<form method="post" action="{{ path('app_game_join', {id: game.id}) }}" class="neo-animate-slideIn">
						<input type="hidden" name="_token" value="{{ csrf_token('join-team-' ~ game.id ~ '-A') }}">
						<input type="hidden" name="team" value="A">
						<button type="submit" class="neo-btn neo-btn-primary neo-btn-full neo-mt-sm">
							<i class="material-icons" style="margin-right: 0.5rem;">group_add</i>
							Rejoindre l'√©quipe A
						</button>
					</form>
				{% elseif userMembership and userMembership.team.name == 'TeamA' %}
					<div class="neo-alert neo-alert-success neo-mt-sm">
						<i class="material-icons" style="margin-right: 0.5rem;">check_circle</i>
						<span>Vous √™tes dans cette √©quipe</span>
					</div>
				{% endif %}
			</div>

			<div class="team-section team-b">
				<div class="team-header">
					<i class="material-icons">group</i>
					<span class="team-badge">√âquipe B</span>
					<span class="team-count">{{ teamB.members|length }} joueur{{ teamB.members|length > 1 ? 's' : '' }}</span>
				</div>
				{% if teamB and teamB.members|length > 0 %}
					<ul class="player-list">
					{% for member in teamB.members %}
						<li class="player-item{% if currentPlayer and currentPlayer.id == member.id %} current-player{% endif %}">
							<div class="player-info">
								<div class="player-avatar">
									<i class="material-icons">{{ member.user.displayName ? 'account_circle' : 'person_outline' }}</i>
								</div>
								<div class="player-details">
									<span class="player-name">
										{{ member.user.displayName ?? ('Joueur #' ~ loop.index) }}
									</span>
									<span class="player-meta">
										<i class="material-icons tiny">schedule</i>
										Rejoint {{ member.joinedAt|date('d/m √† H:i') }}
										{% if member.position > 0 %}
											‚Ä¢ Position {{ member.position }}
										{% endif %}
									</span>
								</div>
							</div>
							<div class="player-status">
								{% if currentPlayer and currentPlayer.id == member.id %}
									<span class="status-current">
										<i class="material-icons">play_arrow</i>
										√Ä son tour
									</span>
								{% elseif member.isReadyToStart %}
									<span class="status-ready">
										<i class="material-icons">check_circle</i>
										Pr√™t
									</span>
								{% else %}
									<span class="status-waiting">
										<i class="material-icons">hourglass_empty</i>
										En attente
									</span>
								{% endif %}
								{% if userMembership and userMembership.id == member.id %}
									<span class="status-you">
										<i class="material-icons">star</i>
										Vous
									</span>
								{% endif %}
							</div>
						</li>
					{% endfor %}
					</ul>
				{% else %}
					<div class="empty-team">
						<i class="material-icons">group_add</i>
						<p>Aucun joueur dans cette √©quipe</p>
					</div>
				{% endif %}
				{% if is_granted('IS_AUTHENTICATED_FULLY') and not userMembership and game.status == 'lobby' %}
					<form method="post" action="{{ path('app_game_join', {id: game.id}) }}" class="neo-animate-slideIn">
						<input type="hidden" name="_token" value="{{ csrf_token('join-team-' ~ game.id ~ '-B') }}">
						<input type="hidden" name="team" value="B">
						<button type="submit" class="neo-btn neo-btn-error neo-btn-full neo-mt-sm">
							<i class="material-icons" style="margin-right: 0.5rem;">group_add</i>
							Rejoindre l'√©quipe B
						</button>
					</form>
				{% elseif userMembership and userMembership.team.name == 'TeamB' %}
					<div class="neo-alert neo-alert-success neo-mt-sm">
						<i class="material-icons" style="margin-right: 0.5rem;">check_circle</i>
						<span>Vous √™tes dans cette √©quipe</span>
					</div>
				{% endif %}
			</div>

					{% if game.invite %}
						<div class="neo-card neo-mt-lg">
							<div class="neo-card-header">
								<h3 class="neo-card-title">
									<i class="material-icons" style="margin-right: 0.5rem;">share</i>
									Partage
								</h3>
							</div>
							<div class="neo-card-content">
								<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
									<span class="neo-text-sm neo-font-medium">Code d'invitation:</span>
									<code class="neo-code">{{ game.invite.code }}</code>
								</div>
								<a href="{{ path('app_game_show_page', {'id': game.id}) }}" class="neo-btn neo-btn-primary neo-btn-sm neo-mt-sm">
									<i class="material-icons" style="margin-right: 0.25rem;">link</i>
									Partager la page
								</a>
							</div>
						</div>
					{% endif %}

					{# Actions utilisateur #}
					<div style="margin-top: 1rem;">
						{# Bouton Pr√™t/Pas pr√™t #}
						{% if is_granted('IS_AUTHENTICATED_FULLY') and userMembership and game.status == 'lobby' %}
							<form method="post" action="{{ path('app_game_ready', {id: game.id}) }}" class="neo-animate-slideIn">
								<input type="hidden" name="_token" value="{{ csrf_token('toggle-ready-' ~ game.id) }}">
								{% if userMembership.isReadyToStart %}
									<button type="submit" class="neo-btn neo-btn-warning neo-btn-lg neo-btn-full">
										<i class="material-icons" style="margin-right: 0.5rem;">pause</i>
										Je ne suis plus pr√™t
									</button>
								{% else %}
									<button type="submit" class="neo-btn neo-btn-success neo-btn-lg neo-btn-full neo-btn-pulse">
										<i class="material-icons" style="margin-right: 0.5rem;">check</i>
										Je suis pr√™t !
									</button>
								{% endif %}
							</form>
						{% endif %}

						{# Bouton D√©marrer la partie (pour le cr√©ateur) #}
						{% if is_granted('IS_AUTHENTICATED_FULLY') and isCreator and canStart %}
							<form method="post" action="{{ path('app_game_start_game', {id: game.id}) }}" class="neo-animate-slideIn" style="margin-top: 0.5rem;">
								<input type="hidden" name="_token" value="{{ csrf_token('start-game-' ~ game.id) }}">
								<button type="submit" class="neo-btn neo-btn-primary neo-btn-lg neo-btn-full neo-btn-pulse">
									<i class="material-icons" style="margin-right: 0.5rem;">play_arrow</i>
									D√©marrer la partie
								</button>
							</form>
						{% endif %}
					</div>

					{# Messages d'√©tat #}
					{% if game.status == 'lobby' and not allReady %}
						<div class="neo-alert neo-alert-info neo-mt-lg">
							<i class="material-icons" style="margin-right: 0.5rem;">info</i>
							<span>En attente que tous les joueurs soient pr√™ts</span>
						</div>
					{% elseif game.status == 'waiting' and not isCreator %}
						<div class="neo-alert neo-alert-warning neo-mt-lg">
							<i class="material-icons" style="margin-right: 0.5rem;">hourglass_empty</i>
							<span>En attente que le cr√©ateur d√©marre la partie</span>
						</div>
					{% endif %}

					{# Petits messages flash #}
					{% for label, messages in app.flashes %}
						{% for message in messages %}
							<div class="flash-{{ label }}" style="margin-top:.5rem;font-size:.9rem;opacity:.85;">
								{{ message }}
							</div>
						{% endfor %}
					{% endfor %}

					</div>
				</div>
			</div>
		</div>
		</div>
	</div>
{% endblock %}
