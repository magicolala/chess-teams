{% extends 'base.html.twig' %}
{% block title %}Partie
	{{ game.id }}
{% endblock %}

{% block styles %}
	<style>
		.cg-wrap {
			width: 480px;
			height: 480px;
		}
		.panel {
			border: 1px solid #eee;
			padding: 0.75rem;
			border-radius: 0.5rem;
		}
		.moves {
			font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
			font-size: 0.95rem;
		}
		.row {
			display: flex;
			gap: 1rem;
			align-items: flex-start;
		}
	</style>
{% endblock %}

{% block body %}
	<h1>Partie</h1>

	<div class="row" data-controller="game-board game-poll" data-game-board-fen-value="{{ initial.fen }}" data-game-board-game-id-value="{{ initial.gameId }}" data-game-board-turn-team-value="{{ initial.turnTeam }}" data-game-board-status-value="{{ initial.status }}" data-game-board-deadline-ts-value="{{ initial.turnDeadline ?: 0 }}" data-game-poll-game-id-value="{{ initial.gameId }}">
		<div>
			<div id="board" class="cg-wrap"></div>
			<div style="margin-top:.5rem">
				<button data-action="game-board#offerMove" data-uci="e2e4">Jouer e2e4 (démo)</button>
				<button data-action="game-board#tick">Tick (timeout)</button>
			</div>
			<div class="panel" style="margin-top:.5rem">
				<div>Tour:
					<strong data-game-board-target="turnTeam"></strong>
				</div>
				<div>Timer:
					<span data-game-board-target="timer"></span>
				</div>
				<div>Status:
					<span data-game-board-target="status"></span>
					<span data-game-board-target="result"></span>
				</div>
			</div>
		</div>

		<div class="panel" style="flex:1">
			<h3>Coups</h3>
			<ol class="moves" id="moves-list">
				{% for m in moves %}
					<li>#{{ m.ply }}:
						{{ m.san ?? m.uci }}
						<small>({{ m.team.name }})</small>
					</li>
				{% endfor %}
			</ol>
		</div>

		<div class="panel" style="width:260px">
			<h3>Équipes</h3>

			<p>A:
				{{ teamA.members|length }}
				joueurs</p>
			{% if is_granted('IS_AUTHENTICATED_FULLY') %}
				<form method="post" action="{{ path('app_game_join', {id: game.id}) }}" style="margin:.25rem 0;">
					<input type="hidden" name="_token" value="{{ csrf_token('join-team-' ~ game.id ~ '-A') }}">
					<input type="hidden" name="team" value="A">
					<button type="submit">Rejoindre l’équipe A</button>
				</form>
			{% endif %}

			<p style="margin-top:.5rem;">B:
				{{ teamB.members|length }}
				joueurs</p>
			{% if is_granted('IS_AUTHENTICATED_FULLY') %}
				<form method="post" action="{{ path('app_game_join', {id: game.id}) }}" style="margin:.25rem 0;">
					<input type="hidden" name="_token" value="{{ csrf_token('join-team-' ~ game.id ~ '-B') }}">
					<input type="hidden" name="team" value="B">
					<button type="submit">Rejoindre l’équipe B</button>
				</form>
			{% endif %}

			{% if game.invite %}
				<p style="margin-top:.75rem;">Code d'invitation :
					<code>{{ game.invite.code }}</code>
				</p>
			{% endif %}

			<p>
				<a href="{{ path('app_game_show_page', {'id': game.id}) }}">Partager la page</a>
			</p>

			{# Petits messages flash #}
			{% for label, messages in app.flashes %}
				{% for message in messages %}
					<div class="flash-{{ label }}" style="margin-top:.5rem;font-size:.9rem;opacity:.85;">
						{{ message }}
					</div>
				{% endfor %}
			{% endfor %}
		</div>
	</div>
{% endblock %}
