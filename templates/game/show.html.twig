{% extends 'base.html.twig' %}
{% block title %}Partie
	{{ game.id }}
{% endblock %}

{% block styles %}
	<style>
		/* Layout côte à côte avec NeoChess Framework */
		.game-layout {
			display: grid;
			grid-template-columns: minmax(400px, 1fr) 420px;
			gap: var(--neo-spacing-xl);
			align-items: start;
		}

		.board-section {
			display: flex;
			flex-direction: column;
			gap: var(--neo-spacing-lg);
			align-items: center;
		}

		#board {
			/* Échiquier qui prend l'espace disponible */
			width: min(100%, calc(100vw - 520px)) !important;
			max-width: 700px;
			min-width: 400px;
			aspect-ratio: 1;
			margin: 0 auto;
			position: relative;
			border-radius: var(--neo-radius, 0px);
			box-shadow: var(--neo-shadow-lg);
			overflow: hidden;
			border: 1px solid var(--neo-border-light);
		}

		.sidebar-section {
			display: flex;
			flex-direction: column;
			gap: var(--neo-spacing-lg);
			height: fit-content;
		}

		/* Responsive pour mobile */
		@media(max-width: 1024px) {
			.game-layout {
				grid-template-columns: 1fr;
				gap: var(--neo-spacing-lg);
			}
		}

		/* Forcer les dimensions pour tous les éléments internes de l'échiquier */
		#board .cg-wrap,
		#board cg-container,
		#board cg-board {
			width: 100% !important;
			height: 100% !important;
			max-width: none !important;
			max-height: none !important;
		}

		/* =========================== */
		/* STYLES PERSONNALISÉS POUR NEOCHESSBOARD */
		/* =========================== */

		/* Note: NeoChessBoard utilise un Canvas, les pièces sont déjà centrées dans le code JS */
		/* Ces styles s'appliquent aux éventuels éléments DOM de debug ou fallback */

		/* Style global de l'échiquier NeoChessBoard */
		#board canvas {
			border-radius: 8px;
			box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
			cursor: pointer;
			/* Masquer le canvas par défaut pour éviter tout flicker avant l'overlay/JS */
			visibility: hidden;
		}

		#board canvas:hover {
			box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
		}
		.game-actions {
			display: flex;
			gap: 0.5rem;
			flex-wrap: wrap;
			justify-content: center;
		}
		.moves-list {
			font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
			font-size: 0.9rem;
			max-height: 200px;
			overflow-y: auto;
			padding: 0;
			margin: 0;
		}
		.move-item {
			display: flex;
			justify-content: space-between;
			padding: 0.25rem 0.5rem;
			border-bottom: 1px solid var(--neo-border-light);
			cursor: pointer;
			transition: background-color 0.1s ease-in-out;
		}

		.move-item:hover {
			background-color: var(--neo-bg-hover);
		}
		.player-list {
			list-style: none;
			padding: 0;
			margin: 0;
			gap: 0.5rem;
			display: flex;
			flex-direction: column;
		}
		.player-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0.75rem;
			background: var(--neo-bg-secondary);
			border-radius: 8px;
			border: 1px solid var(--neo-border-light);
			cursor: pointer;
			transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
		}

		.player-item:hover {
			transform: translateY(-2px);
			box-shadow: var(--neo-shadow-sm);
		}
		.player-item.current-player {
			border-color: var(--neo-accent-primary);
			background: var(--neo-accent-primary-light);
		}
		.player-info {
			display: flex;
			align-items: center;
			gap: 0.75rem;
		}
		.player-details {
			display: flex;
			flex-direction: column;
			gap: 0.25rem;
		}
		.player-name {
			font-weight: 600;
			color: var(--neo-text-primary);
		}
		.player-meta {
			font-size: 0.8rem;
			color: var(--neo-text-secondary);
		}
		.player-status {
			display: flex;
			gap: 0.5rem;
			align-items: center;
		}
		/* Styles pour les équipes et statuts */
		.team-section {
			margin-bottom: var(--neo-spacing-xl);
		}
		.team-header {
			display: flex;
			align-items: center;
			gap: var(--neo-spacing-sm);
			margin-bottom: var(--neo-spacing-md);
			padding-bottom: var(--neo-spacing-sm);
			border-bottom: 1px solid var(--neo-border-light);
		}
		.team-badge {
			font-weight: var(--neo-font-weight-semibold);
			color: var(--neo-text-primary);
		}
		.team-count {
			font-size: var(--neo-font-size-sm);
			color: var(--neo-text-muted);
		}
		.empty-team {
			text-align: center;
			padding: var(--neo-spacing-xl);
			color: var(--neo-text-muted);
		}
		.empty-team i {
			font-size: 2rem;
			margin-bottom: var(--neo-spacing-sm);
			display: block;
		}
		.status-current {
			color: var(--neo-success);
			font-weight: var(--neo-font-weight-medium);
		}
		.status-ready {
			color: var(--neo-info);
			font-weight: var(--neo-font-weight-medium);
		}
		.status-waiting {
			color: var(--neo-text-muted);
		}
		.status-you {
			color: var(--neo-accent-primary);
			font-weight: var(--neo-font-weight-semibold);
		}
		.material-icons.tiny {
			font-size: 0.875rem;
		}
		@media(max-width: 768px) {
			.game-container {
				grid-template-columns: 1fr;
				gap: 1rem;
			}
		}
		/* Force les styles de boutons pour s'assurer qu'ils s'appliquent */
		.neo-btn {
			padding: var(--neo-spacing-sm, 8px) var(--neo-spacing-md, 12px);
			background: var(--neo-bg-hover, #222730);
			border: none;
			color: var(--neo-text-secondary, #c2c8d2);
			border-radius: var(--neo-radius, 0px);
			transition: all 0.15s ease;
			font-size: var(--neo-font-size-sm, 0.875rem);
			font-weight: var(--neo-font-weight-medium, 500);
			cursor: pointer;
			display: inline-flex;
			align-items: center;
			gap: var(--neo-spacing-sm, 8px);
			text-decoration: none;
			font-family: inherit;
		}
		.neo-btn:hover {
			background: var(--neo-bg-active, #2a313a);
			color: var(--neo-text-primary, #e6e9ee);
		}
		.neo-btn-sm {
			padding: var(--neo-spacing-sm, 8px) var(--neo-spacing-md, 12px);
			font-size: var(--neo-font-size-sm, 0.875rem);
		}
		.neo-btn-lg {
			padding: var(--neo-spacing-md, 12px) var(--neo-spacing-xl, 24px);
			font-size: var(--neo-font-size-lg, 1.125rem);
		}
		.neo-btn-full {
			width: 100%;
			justify-content: center;
		}
		.neo-btn-secondary {
			background: var(--neo-bg-secondary, #15181d);
			color: var(--neo-text-secondary, #c2c8d2);
			border: 1px solid var(--neo-border-light, #262a31);
		}
		.neo-btn-secondary:hover {
			background: var(--neo-bg-active, #2a313a);
			color: var(--neo-text-primary, #e6e9ee);
			border-color: var(--neo-border-medium, #3a4048);
		}
		.neo-btn-success {
			background: var(--neo-bg-active, #2a313a);
			color: var(--neo-text-primary, #e6e9ee);
		}
		.neo-btn-success:hover {
			background: var(--neo-success, #10b981);
			color: white;
		}
		.neo-btn-warning {
			background: var(--neo-bg-active, #2a313a);
			color: var(--neo-text-primary, #e6e9ee);
		}
		.neo-btn-warning:hover {
			background: var(--neo-warning, #f59e0b);
			color: white;
		}
		.neo-btn-primary {
			background: var(--neo-bg-active, #2a313a);
			color: var(--neo-text-primary, #e6e9ee);
		}
		.neo-btn-primary:hover {
			background: var(--neo-accent-primary, #4f46e5);
			color: white;
		}
		.neo-btn-error {
			background: var(--neo-bg-active, #2a313a);
			color: var(--neo-text-primary, #e6e9ee);
		}
		.neo-btn-error:hover {
			background: var(--neo-error, #ef4444);
			color: white;
		}
		.neo-btn-pulse {
			animation: neo-pulse-success 2s infinite;
		}
		@keyframes neo-pulse-success {
			0% {
				box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
			}
			70% {
				box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
			}
			100% {
				box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
			}
		}

		/* Styles pour les boutons toggle des notifications */
		.neo-toggle {
			position: relative;
			display: inline-block;
			width: 50px;
			height: 24px;
		}

		.neo-toggle input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		.neo-toggle-slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: var(--neo-bg-secondary, #15181d);
			border: 1px solid var(--neo-border-light, #262a31);
			transition: .4s;
			border-radius: 12px;
		}

		.neo-toggle-slider:before {
			position: absolute;
			content: "";
			height: 18px;
			width: 18px;
			left: 2px;
			bottom: 2px;
			background-color: var(--neo-text-secondary, #c2c8d2);
			transition: .4s;
			border-radius: 50%;
		}

		.neo-toggle input:checked + .neo-toggle-slider {
			background-color: var(--neo-accent-primary, #4f46e5);
			border-color: var(--neo-accent-primary, #4f46e5);
		}

		.neo-toggle input:checked + .neo-toggle-slider:before {
			transform: translateX(26px);
			background-color: white;
		}

		/* Classes utilitaires pour les espaces */
		.neo-gap-sm {
			gap: var(--neo-spacing-sm, 0.5rem);
		}
	</style>
{% endblock %}

{% block body %}
	<div class="neo-animate-fadeIn">
		<div class="neo-text-center neo-mb-xl">
			<h1 class="neo-text-2xl neo-font-bold neo-text-primary">
				♟️ Partie
				{{ game.id }}
			</h1>
		</div>

		<div
			class="game-layout neo-animate-slideIn"
			data-controller="game-board game-poll game-mercure"
			data-game-board-fen-value="{{ initial.fen }}"
			data-game-board-game-id-value="{{ initial.gameId }}"
			data-game-board-turn-team-value="{{ initial.turnTeam }}"
			data-game-board-status-value="{{ initial.status }}"
			data-game-board-deadline-ts-value="{{ initial.turnDeadline ?: 0 }}"
			data-game-poll-game-id-value="{{ initial.gameId }}"
			data-game-mercure-game-id-value="{{ initial.gameId }}"
			data-game-mercure-url-value="{{ mercure(['/games/' ~ initial.gameId]) }}"
			{% if userMembership %}data-user-team="{{ userMembership.team.name }}"{% endif %}>
			<!-- Section de gauche: Échiquier + Actions -->
			<div class="board-section">
				<div id="board" class="cg-wrap coordinates"></div>
				<div class="game-actions">
					<button class="neo-btn neo-btn-secondary neo-btn-sm" data-action="game-board#offerMove" data-uci="e2e4">
						▶️ Jouer e2e4 (démo)
					</button>
					<button class="neo-btn neo-btn-warning neo-btn-sm" data-action="game-board#tick">
						⏰ Tick (timeout)
					</button>
				</div>
			</div>

			<!-- Section de droite: État + Historique + Équipes -->
			<div class="sidebar-section">
				<div class="neo-card neo-mb-lg">
					<div class="neo-card-header">
						<h3 class="neo-card-title">ℹ️ État de la partie</h3>
					</div>
					<div class="neo-card-content">
						<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
							<span class="neo-text-sm neo-font-medium">Tour actuel:</span>
							<span class="neo-badge neo-badge-primary" data-game-board-target="turnTeam">{{ initial.turnTeam }}</span>
						</div>
						{# Werewolf mode badge and personal role reminder #}
						{% if initial.mode == 'werewolf' %}
							<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
								<span class="neo-text-sm neo-font-medium">Mode:</span>
								<span class="neo-badge neo-badge-warning">Loup-Garou</span>
							</div>
							{% if myRole %}
								<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-info neo-rounded">
									<span class="neo-text-sm neo-font-medium">Votre rôle:</span>
									<span class="neo-text-sm">{{ myRole == 'werewolf' ? 'Loup-Garou' : 'Villageois' }}</span>
								</div>
							{% endif %}
							{% if game.voteOpen %}
								<div class="neo-alert neo-alert-info neo-mt-sm">
									<i class="material-icons" style="margin-right: 0.5rem;">how_to_vote</i>
									<span>Phase de vote Loup-Garou en cours. Choisissez le suspect depuis l'interface dédiée (à venir) ou via l'API.</span>
								</div>
							{% endif %}
						{% endif %}
						{% if currentPlayer and game.status == 'live' %}
							<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-info neo-rounded">
								<span class="neo-text-sm neo-font-medium">Joueur actuel:</span>
								<span class="neo-text-sm">
									{{ currentPlayer.user.displayName ?? 'Joueur' }}
									(Équipe
									{{ currentPlayer.team.name }})
									{% if userMembership and userMembership.id == currentPlayer.id %}
										⭐
									{% endif %}
								</span>
							</div>
						{% endif %}
						<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
							<span class="neo-text-sm neo-font-medium">Chronomètre moderne:</span>
							<div class="timer-container" 
								data-controller="chess-timer" 
								data-chess-timer-game-id-value="{{ game.id }}"
								data-chess-timer-max-days-value="14"
								data-chess-timer-fast-time-value="60"
								data-chess-timer-current-deadline-value="{{ initial.turnDeadline ?: 0 }}"
								data-chess-timer-is-player-turn-value="{{ userMembership and userMembership.team.name == initial.turnTeam ? 'true' : 'false' }}"
								data-chess-timer-game-status-value="{{ game.status }}">
								<div data-chess-timer-target="display"></div>
							</div>
						</div>
						<div class="neo-flex neo-justify-between neo-items-center neo-p-sm neo-bg-secondary neo-rounded">
							<span class="neo-text-sm neo-font-medium">Statut:</span>
							<div>
								<span class="neo-badge neo-badge-secondary" data-game-board-target="status">{{ initial.status }}</span>
								<span data-game-board-target="result"></span>
							</div>
						</div>
					</div>
				</div>

				{# Panneau de contrôle des notifications #}
				{% if game.status == 'live' and userMembership %}
					<div class="neo-card neo-mb-lg" data-controller="notification-controls">
						<div class="neo-card-header">
							<h3 class="neo-card-title">
								<i class="material-icons" style="margin-right: 0.5rem;">notifications</i>
								Notifications
							</h3>
						</div>
						<div class="neo-card-content">
							<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
								<div class="neo-flex neo-items-center neo-gap-sm">
									<i class="material-icons tiny">desktop_windows</i>
									<span class="neo-text-sm neo-font-medium">Notifications de bureau:</span>
								</div>
								<label class="neo-toggle">
									<input type="checkbox" data-notification-controls-target="desktopToggle" data-action="change->notification-controls#toggleDesktopNotifications">
									<span class="neo-toggle-slider"></span>
								</label>
							</div>
							<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
								<div class="neo-flex neo-items-center neo-gap-sm">
									<i class="material-icons tiny">volume_up</i>
									<span class="neo-text-sm neo-font-medium">Sons de notification:</span>
								</div>
								<label class="neo-toggle">
									<input type="checkbox" data-notification-controls-target="soundToggle" data-action="change->notification-controls#toggleSoundNotifications" checked>
									<span class="neo-toggle-slider"></span>
								</label>
							</div>
							<div class="neo-flex neo-justify-between neo-items-center neo-p-sm neo-bg-secondary neo-rounded">
								<div class="neo-flex neo-items-center neo-gap-sm">
									<i class="material-icons tiny">flash_on</i>
									<span class="neo-text-sm neo-font-medium">Flash du titre:</span>
								</div>
								<label class="neo-toggle">
									<input type="checkbox" data-notification-controls-target="flashToggle" data-action="change->notification-controls#toggleFlashNotifications" checked>
									<span class="neo-toggle-slider"></span>
								</label>
							</div>
							<div class="neo-text-xs neo-text-muted neo-mt-sm">
								<i class="material-icons tiny">info</i>
								Vous serez alerté quand c'est votre tour de jouer
							</div>
						</div>
					</div>
				{% endif %}

				{# Panneau de décision après timeout (affiché seulement si nécessaire) #}
                <div class="neo-card neo-mb-lg" data-game-board-target="timeoutDecision" style="display: none;">
                    <div class="neo-card-header">
                        <h3 class="neo-card-title">⏰ Décision après timeout</h3>
                    </div>
                    <div class="neo-card-content">
                        <p class="neo-text-sm neo-text-secondary neo-mb-sm">L'adversaire a dépassé le temps. Que souhaitez-vous faire ?</p>
                        <div class="neo-flex neo-gap-sm">
                            <button class="neo-btn neo-btn-warning neo-btn-full" data-decision="end" data-action="game-board#decideTimeout">
                                🛑 Mettre fin à la partie (victoire)
                            </button>
                            <button class="neo-btn neo-btn-success neo-btn-full" data-decision="allow_next" data-action="game-board#decideTimeout">
                                ▶️ Laisser le suivant jouer
                            </button>
                        </div>
                    </div>
                </div>

				<div class="neo-card neo-mb-lg">
					<div class="neo-card-header">
						<h3 class="neo-card-title">📋 Historique des coups</h3>
					</div>
					<div class="neo-card-content">
						<ol class="moves-list" id="moves-list">
							{% for m in moves %}
								<li class="move-item">
									<span class="move-notation">#{{ m.ply }}:
										{{ m.san ?? m.uci }}</span>
									<span class="neo-badge neo-badge-sm team-{{ m.team.name|lower }}">{{ m.team.name }}</span>
								</li>
							{% endfor %}
						</ol>
					</div>
				</div>

				<div class="neo-card">
					<div class="neo-card-header">
						<h3 class="neo-card-title">👥 Équipes</h3>
					</div>
					<div class="neo-card-content">

						<div class="team-section team-whites">
							<div class="team-header">
								<i class="material-icons">group</i>
								<span class="team-badge">♔ Blancs</span>
								<span class="team-count">{{ teamA.members|length }}
									joueur{{ teamA.members|length > 1 ? 's' : '' }}</span>
							</div>
							{% if teamA and teamA.members|length > 0 %}
								<ul class="player-list">
									{% for member in teamA.members %}
										<li class="player-item{% if currentPlayer and currentPlayer.id == member.id %} current-player{% endif %}">
											<div class="player-info">
												<div class="player-avatar">
													<i class="material-icons">{{ member.user.displayName ? 'account_circle' : 'person_outline' }}</i>
												</div>
												<div class="player-details">
													<span class="player-name">
														{{ member.user.displayName ?? ('Joueur #' ~ loop.index) }}
													</span>
													<span class="player-meta">
														<i class="material-icons tiny">schedule</i>
														Rejoint
														{{ member.joinedAt|date('d/m à H:i') }}
														{% if member.position > 0 %}
															• Position
															{{ member.position }}
														{% endif %}
													</span>
												</div>
											</div>
											<div class="player-status">
												{% if currentPlayer and currentPlayer.id == member.id %}
													<span class="status-current">
														<i class="material-icons">play_arrow</i>
														À son tour
													</span>
												{% elseif member.isReadyToStart %}
													<span class="status-ready">
														<i class="material-icons">check_circle</i>
														Prêt
													</span>
												{% else %}
													<span class="status-waiting">
														<i class="material-icons">hourglass_empty</i>
														En attente
													</span>
												{% endif %}
												{% if userMembership and userMembership.id == member.id %}
													<span class="status-you">
														<i class="material-icons">star</i>
														Vous
													</span>
												{% endif %}
											</div>
										</li>
									{% endfor %}
								</ul>
							{% else %}
								<div class="empty-team">
									<i class="material-icons">group_add</i>
									<p>Aucun joueur dans cette équipe</p>
								</div>
							{% endif %}
							{% if is_granted('IS_AUTHENTICATED_FULLY') and not userMembership and game.status == 'lobby' %}
								<form method="post" action="{{ path('app_game_join', {id: game.id}) }}" class="neo-animate-slideIn">
									<input type="hidden" name="_token" value="{{ csrf_token('join-team-' ~ game.id ~ '-A') }}">
									<input type="hidden" name="team" value="A">
									<button type="submit" class="neo-btn neo-btn-primary neo-btn-full neo-mt-sm">
										<i class="material-icons" style="margin-right: 0.5rem;">group_add</i>
										Rejoindre les Blancs ♔
									</button>
								</form>
							{% elseif userMembership and userMembership.team.name == 'A' %}
								<div class="neo-alert neo-alert-success neo-mt-sm">
									<i class="material-icons" style="margin-right: 0.5rem;">check_circle</i>
									<span>Vous êtes dans cette équipe</span>
								</div>
							{% endif %}
						</div>

						<div class="team-section team-blacks">
							<div class="team-header">
								<i class="material-icons">group</i>
								<span class="team-badge">♚ Noirs</span>
								<span class="team-count">{{ teamB.members|length }}
									joueur{{ teamB.members|length > 1 ? 's' : '' }}</span>
							</div>
							{% if teamB and teamB.members|length > 0 %}
								<ul class="player-list">
									{% for member in teamB.members %}
										<li class="player-item{% if currentPlayer and currentPlayer.id == member.id %} current-player{% endif %}">
											<div class="player-info">
												<div class="player-avatar">
													<i class="material-icons">{{ member.user.displayName ? 'account_circle' : 'person_outline' }}</i>
												</div>
												<div class="player-details">
													<span class="player-name">
														{{ member.user.displayName ?? ('Joueur #' ~ loop.index) }}
													</span>
													<span class="player-meta">
														<i class="material-icons tiny">schedule</i>
														Rejoint
														{{ member.joinedAt|date('d/m à H:i') }}
														{% if member.position > 0 %}
															• Position
															{{ member.position }}
														{% endif %}
													</span>
												</div>
											</div>
											<div class="player-status">
												{% if currentPlayer and currentPlayer.id == member.id %}
													<span class="status-current">
														<i class="material-icons">play_arrow</i>
														À son tour
													</span>
												{% elseif member.isReadyToStart %}
													<span class="status-ready">
														<i class="material-icons">check_circle</i>
														Prêt
													</span>
												{% else %}
													<span class="status-waiting">
														<i class="material-icons">hourglass_empty</i>
														En attente
													</span>
												{% endif %}
												{% if userMembership and userMembership.id == member.id %}
													<span class="status-you">
														<i class="material-icons">star</i>
														Vous
													</span>
												{% endif %}
											</div>
										</li>
									{% endfor %}
								</ul>
							{% else %}
								<div class="empty-team">
									<i class="material-icons">group_add</i>
									<p>Aucun joueur dans cette équipe</p>
								</div>
							{% endif %}
							{% if is_granted('IS_AUTHENTICATED_FULLY') and not userMembership and game.status == 'lobby' %}
								<form method="post" action="{{ path('app_game_join', {id: game.id}) }}" class="neo-animate-slideIn">
									<input type="hidden" name="_token" value="{{ csrf_token('join-team-' ~ game.id ~ '-B') }}">
									<input type="hidden" name="team" value="B">
									<button type="submit" class="neo-btn neo-btn-error neo-btn-full neo-mt-sm">
										<i class="material-icons" style="margin-right: 0.5rem;">group_add</i>
										Rejoindre les Noirs ♚
									</button>
								</form>
							{% elseif userMembership and userMembership.team.name == 'B' %}
								<div class="neo-alert neo-alert-success neo-mt-sm">
									<i class="material-icons" style="margin-right: 0.5rem;">check_circle</i>
									<span>Vous êtes dans cette équipe</span>
								</div>
							{% endif %}
						</div>

						{% if game.invite %}
							<div class="neo-card neo-mt-lg">
								<div class="neo-card-header">
									<h3 class="neo-card-title">
										<i class="material-icons" style="margin-right: 0.5rem;">share</i>
										Partage
									</h3>
								</div>
								<div class="neo-card-content">
									<div class="neo-flex neo-justify-between neo-items-center neo-mb-sm neo-p-sm neo-bg-secondary neo-rounded">
										<span class="neo-text-sm neo-font-medium">Code d'invitation:</span>
										<code class="neo-code">{{ game.invite.code }}</code>
									</div>
									<a href="{{ path('app_game_show_page', {'id': game.id}) }}" class="neo-btn neo-btn-primary neo-btn-sm neo-mt-sm">
										<i class="material-icons" style="margin-right: 0.25rem;">link</i>
										Partager la page
									</a>
								</div>
							</div>
						{% endif %}

						{# Actions utilisateur #}
						<div
							style="margin-top: 1rem;">
							{# Boutons Prêt/Pas prêt avec AJAX #}
							{% if is_granted('IS_AUTHENTICATED_FULLY') and userMembership and game.status == 'lobby' %}
								<div class="neo-animate-slideIn">
									{% if userMembership.isReadyToStart %}
										<button data-action="game-board#markNotReady" class="neo-btn neo-btn-warning neo-btn-lg neo-btn-full">
											<i class="material-icons" style="margin-right: 0.5rem;">pause</i>
											Je ne suis plus prêt
										</button>
									{% else %}
										<button data-action="game-board#markReady" class="neo-btn neo-btn-success neo-btn-lg neo-btn-full neo-btn-pulse">
											<i class="material-icons" style="margin-right: 0.5rem;">check</i>
											Je suis prêt !
										</button>
									{% endif %}
								</div>
							{% endif %}

							{# Bouton Démarrer la partie (pour le créateur) #}
							{% if is_granted('IS_AUTHENTICATED_FULLY') and isCreator and canStart %}
								<form method="post" action="{{ path('app_game_start_game', {id: game.id}) }}" class="neo-animate-slideIn" style="margin-top: 0.5rem;">
									<input type="hidden" name="_token" value="{{ csrf_token('start-game-' ~ game.id) }}">
									<button type="submit" class="neo-btn neo-btn-primary neo-btn-lg neo-btn-full neo-btn-pulse">
										<i class="material-icons" style="margin-right: 0.5rem;">play_arrow</i>
										Démarrer la partie
									</button>
								</form>
							{% endif %}

							{# Bouton Revendiquer la victoire (après 3 timeouts consécutifs) #}
							<div class="claim-victory-section" data-game-poll-target="claimSection" style="display: none;">
								<div class="neo-alert neo-alert-warning neo-mt-lg">
									<i class="material-icons" style="margin-right: 0.5rem;">warning</i>
									<div>
										<h4>L'adversaire a fait plusieurs timeouts consécutifs</h4>
										<p>Vous pouvez revendiquer la victoire par abandon.</p>
									</div>
								</div>
								<button data-action="game-board#claimVictory" class="neo-btn neo-btn-warning neo-btn-lg neo-btn-full neo-mt-sm">
									<i class="material-icons" style="margin-right: 0.5rem;">emoji_events</i>
									Revendiquer la victoire
								</button>
							</div>
						</div>

						{# Messages d'état #}
						{% if game.status == 'lobby' and not allReady %}
							<div class="neo-alert neo-alert-info neo-mt-lg">
								<i class="material-icons" style="margin-right: 0.5rem;">info</i>
								<span>En attente que tous les joueurs soient prêts</span>
							</div>
						{% elseif game.status == 'waiting' and not isCreator %}
							<div class="neo-alert neo-alert-warning neo-mt-lg">
								<i class="material-icons" style="margin-right: 0.5rem;">hourglass_empty</i>
								<span>En attente que le créateur démarre la partie</span>
							</div>
						{% endif %}

						{# Werewolf voting UI (visible aux participants pendant la phase de vote) #}
						{% if initial.mode == 'werewolf' and userMembership and game.voteOpen %}
							<div class="neo-card neo-mt-lg" data-controller="werewolf-vote"
								data-werewolf-vote-game-id-value="{{ game.id }}"
								data-werewolf-vote-api-base-value="">
								<div class="neo-card-header">
									<h3 class="neo-card-title">
										<i class="material-icons" style="margin-right: 0.5rem;">how_to_vote</i>
										Vote Loup-Garou
									</h3>
								</div>
								<div class="neo-card-content" data-werewolf-vote-target="container">
									<div class="neo-text-sm neo-text-muted neo-mb-sm">Choisissez un suspect:</div>
									<div class="neo-flex neo-flex-col neo-gap-sm">
										{# Liste des joueurs des deux équipes #}
										{% for member in teamA.members %}
											<button class="neo-btn neo-btn-secondary neo-btn-full" data-action="werewolf-vote#vote" data-suspect-id="{{ member.user.id }}" data-suspect-name="{{ member.user.displayName ?? ('Joueur ' ~ member.user.id) }}">
												{{ member.user.displayName ?? ('Joueur ' ~ member.user.id) }}
												<span class="neo-badge" style="margin-left:auto">Équipe A</span>
											</button>
										{% endfor %}
										{% for member in teamB.members %}
											<button class="neo-btn neo-btn-secondary neo-btn-full" data-action="werewolf-vote#vote" data-suspect-id="{{ member.user.id }}" data-suspect-name="{{ member.user.displayName ?? ('Joueur ' ~ member.user.id) }}">
												{{ member.user.displayName ?? ('Joueur ' ~ member.user.id) }}
												<span class="neo-badge" style="margin-left:auto">Équipe B</span>
											</button>
										{% endfor %}
									</div>

									<div class="neo-divider neo-my-md"></div>
									<h4 class="neo-text-sm neo-text-secondary neo-mb-sm">Résultats en direct</h4>
									<div data-werewolf-vote-target="results"></div>
									<div class="neo-text-xs neo-text-muted neo-mt-sm" data-werewolf-vote-target="status"></div>
								</div>
							</div>
						{% endif %}


					</div>
				</div>
			</div>
		</div>
	</div>
</div>{% endblock %}

